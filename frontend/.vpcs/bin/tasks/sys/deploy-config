#!/usr/bin/env bash
#- vpcs sys deploy-config - Defines configuration in .meta folder for deploy

PrimaryApp="$(cat $(locate vpcs-config) | yq '.apps.primary')"
[[ -z "$PrimaryApp" ]] && PrimaryApp="$(cat $APP_ROOT/project.json | jq -r '.name')"
[[ -z "$PrimaryApp" ]] && vpcs log error "No primary app found in vpcs-config or project.json! Please add .apps.primary in vpcs.yml" && exit 1

[[ -z "$(which raptor)" ]] && vpcs install raptor
# which step of raptor are we in?
# first step creates deploy directory in .meta
if [[ ! -d $APP_ROOT/.meta ]]; then
  vpcs log info "Deploy config step 1 detected - running cloud setup"
  raptor cloud:setup --service=$PrimaryApp --type=api --helm --directory=$APP_ROOT --component=app --yes
elif [[ ! -f $APP_ROOT/.deploy_bot.yml ]]; then
  vpcs log info "Deploy config step 2 detected - running cloud config"
  raptor cd:setup --service=$PrimaryApp --directory=$APP_ROOT --platform=cloud --yes
elif [[ -f $APP_ROOT/.meta/deployment/common.yml ]]; then
  # see if common.yml has fullName set
  MetaCommonPath="$APP_ROOT/.meta/deployment/cloud/components/app/common.yml"
  if [[ -z "$(cat $MetaCommonPath | yq '.fullName')" ]]; then
    vpcs log info "Setting some defaults in common.yml"
    TemplatePath="$(locate etc)/template/meta-configs"
    yq ". *= load(\"$TemplatePath/common.yml\")" $MetaCommonPath
    yq ".fullName=\"$PrimaryApp\"" -i $MetaCommonPath
  fi
  raptor cloud:render

fi

