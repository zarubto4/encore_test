#!/usr/bin/env bash
#- vpcs sys publish-config - sets publish configuration for all libraries

ProjectLibraries="$(nx show projects)"
for i in $ProjectLibraries; do
  vpcs log info "Setting publish configuration for $i..."
  ProjectConfig="$(nx show project "$i" 2>/dev/null)"
  ProjectRoot="$(echo "$ProjectConfig" | jq -r '.root')"
  DockerImage="docker-generic-us-west-2.artifactory.groupondev.com/alpine:3.16.0"
  vpcs log info "TODO: Configuration for docker image not yet implemented. Defaulting to $DockerImage."
  [[ "$ProjectRoot" =~ lib ]] || continue
  [[ ! -f $ProjectRoot/package.json ]] && vpcs log error "No package.json found in $ProjectRoot!"
  TMPName="$(locate tmp)/package.$(date +%s).json"
  cat $ProjectRoot/package.json | jq '.publishConfig.registry="https://npm.groupondev.com"' | jq '.publishConfig.access="public"' > $TMPName
  cat $TMPName | jq '.targets.nx-release.publish.executor="@nx:js/release-publish"' \
    | jq '.targets.nx-release.publish.options.packageRoot="dist/{projectRoot}"' \
    | jq '.targets.nx-release.publish.options.registry="https://npm.groupondev.com"' \
    | jq '.targets.nx-release.publish.options.access="public"' \
    | jq '.targets.nx-release.publish.options.dryRun=false' > $ProjectRoot/package.json

  cat $(locate etc)/template/Jenkinsfile.library | sed "s/PROJECTNAME/$i/g" | sed "s/IMAGENAME/$DockerImage/g" > $ProjectRoot/Jenkinsfile
done

exit 0