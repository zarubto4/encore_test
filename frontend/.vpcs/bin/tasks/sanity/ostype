#!/bin/sh -e
# vpcs sanity ostype - returns the os. also detects architecture and exports it; this should go into an init env-profile.
# What os are we on
# Macs will show Darwin x86_64 or Darwin arm64
# Don't know alpine yet so will use a different method

[[ ! -z "$VPCS_TaskOS" ]] && echo "$VPCS_TaskOS" && exit 0;
TaskOS=''
if [[ -z "$VPCS_OS_Kernel" ]]; then
  if [[ -x $(which apk) ]]; then
    VPCS_OS_Kernel='linux'
    VPCS_OS_Architecture="$(apk --print-arch)"
    TaskOS='alpine'
  else
    ArchTag="$(uname -a | awk '{print $1, $NF}')"
    export VPCS_OS_Kernel="$(echo $ArchTag | cut -f1 -w)"
    export VPCS_OS_Architecture="$(echo $ArchTag | cut -f2 -w)"
    [[ "$VPCS_OS_Kernel" =~ ^Darwin ]] && TaskOS="mac"
  fi
fi
if  [[ -z "$TaskOS" ]]; then
  echo "Cannot detect OS!"
  exit 1
fi
export VPCS_TaskOS="$TaskOS"
echo "$TaskOS"
exit 0